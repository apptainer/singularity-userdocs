

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Singularity Flow &mdash; Singularity container 2.6.0 documentation</title>




    <link rel="shortcut icon" href="_static/favicon.png"/>


  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Bind Paths and Mounts" href="bind_paths_and_mounts.html" />
    <link rel="prev" title="Container Recipes" href="container_recipes.html" />


  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">


  <div class="wy-grid-for-nav">


    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">



            <a href="index.html" class="icon icon-home"> Singularity container




            <img src="_static/logo.png" class="logo" alt="Logo"/>

          </a>




              <div class="version">
                2.6.0
              </div>



<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">






              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_a_container.html">Build a Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_environment.html">Build Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="container_recipes.html">Container Recipes</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Singularity Flow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#building-images">Building Images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-singularity-flow">The Singularity Flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="#development-commands">1. Development Commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sandbox-folder">Sandbox Folder</a></li>
<li class="toctree-l4"><a class="reference internal" href="#writable-image">Writable Image</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#production-commands">2. Production Commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#recommended-production-build">Recommended Production Build</a></li>
<li class="toctree-l4"><a class="reference internal" href="#production-build-from-sandbox">Production Build from Sandbox</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="bind_paths_and_mounts.html">Bind Paths and Mounts</a></li>
<li class="toctree-l1"><a class="reference internal" href="persistent_overlays.html">Persistent Overlays</a></li>
<li class="toctree-l1"><a class="reference internal" href="running_services.html">Running Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="container_checks.html">Container Checks</a></li>
<li class="toctree-l1"><a class="reference internal" href="environment_and_metadata.html">Environment and Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="reproducible_scif_apps.html">Reproducible SCI-F Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="singularity_and_docker.html">Singularity and Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>



        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">


      <nav class="wy-nav-top" aria-label="top navigation">

          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Singularity container</a>

      </nav>


      <div class="wy-nav-content">

        <div class="rst-content style-external-links">

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">

      <li><a href="index.html">Docs</a> &raquo;</li>

      <li>Singularity Flow</li>


      <li class="wy-breadcrumbs-aside">



              <a href="https://github.com/singularityware/singularity-userdocs/blob/master/singularity_flow.rst" class="fa fa-github"> Edit on GitHub</a>



      </li>

  </ul>


  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <div class="section" id="singularity-flow">
<span id="id1"></span><h1>Singularity Flow<a class="headerlink" href="#singularity-flow" title="Permalink to this headline">¶</a></h1>
<p>This document describes a suggested “best-practices” workflow for
building, running, and managing your containers.</p>
<p>There are generally two ways to get images. You either want to pull an
image file as is, or (more likely) build your own custom image. We
will start with talking about build, and the many different use cases it affords.</p>
<div class="section" id="building-images">
<span id="sec-singularityflow"></span><h2>Building Images<a class="headerlink" href="#building-images" title="Permalink to this headline">¶</a></h2>
<p>If you read the <a class="reference internal" href="quick_start.html#quick-start"><span class="std std-ref">quick start</span></a>, you probably remember that building images from a
Docker base does not require a <a class="reference internal" href="container_recipes.html#container-recipes"><span class="std std-ref">Singularity recipe</span></a>. However, if you do want to build and
customize your image, you can create a <a class="reference internal" href="container_recipes.html#container-recipes"><span class="std std-ref">Singularity recipe</span></a> text file, which is a simple
text file that describes how the container should be made.</p>
<div class="section" id="the-singularity-flow">
<h3>The Singularity Flow<a class="headerlink" href="#the-singularity-flow" title="Permalink to this headline">¶</a></h3>
<p>The diagram below is a visual depiction of how you can use Singularity
to build images. The high level idea is that we have two environments:</p>
<ul class="simple">
<li>a <strong>build</strong> environment (where you have sudo privileges) to test and
build your container</li>
<li>a <strong>production</strong> environment where you run your container</li>
</ul>
<div class="figure" id="id2">
<img alt="Singularity Workflow" src="_images/flow.png" />
<p class="caption"><span class="caption-text">Singularity Workflow</span></p>
</div>
<p>Singularity production images are immutable. This is a feature added as
of Singularity 2.4, and it ensures a higher level of reproducibility and
verification of images. To read more about the details, check out the <a class="reference internal" href="build_a_container.html#build-a-container"><span class="std std-ref">build</span></a>
docs. However, immutability is not so great when you are testing,
debugging, or otherwise want to quickly change your image. We will
proceed by describing a typical workflow of developing first, building a
final image, and using it in production.</p>
</div>
<div class="section" id="development-commands">
<h3>1. Development Commands<a class="headerlink" href="#development-commands" title="Permalink to this headline">¶</a></h3>
<p>If you want a writable image or folder for developing, you have two
options:</p>
<ul class="simple">
<li>build into a directory that has writable permissions using the <code class="docutils literal notranslate"><span class="pre">--sandbox</span></code> option</li>
<li>build into an ext3 image file, that has writable permissions with the <code class="docutils literal notranslate"><span class="pre">--writable</span></code>
option</li>
</ul>
<p>In both cases you will need to execute your container with the <code class="docutils literal notranslate"><span class="pre">--writable</span></code> option at
runtime for your changes to be persistent.</p>
<div class="section" id="sandbox-folder">
<h4>Sandbox Folder<a class="headerlink" href="#sandbox-folder" title="Permalink to this headline">¶</a></h4>
<p>To build into a folder (we call this a “sandbox”) just ask for it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity build --sandbox ubuntu/ docker://ubuntu

Docker image path: index.docker.io/library/ubuntu:latest

Cache folder set to /root/.singularity/docker

Importing: base Singularity environment

Importing: /root/.singularity/docker/sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118.tar.gz

Importing: /root/.singularity/docker/sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a.tar.gz

Importing: /root/.singularity/docker/sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2.tar.gz

Importing: /root/.singularity/docker/sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e.tar.gz

Importing: /root/.singularity/docker/sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9.tar.gz

Importing: /root/.singularity/metadata/sha256:22e289880847a9a2f32c62c237d2f7e3f4eae7259bf1d5c7ec7ffa19c1a483c8.tar.gz

Building image from sandbox: ubuntu/

Singularity container built: ubuntu/
</pre></div>
</div>
<p>We now have a folder with the entire ubuntu OS, plus some Singularity
metadata, plopped in our present working directory.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> $ tree -L 1 ubuntu

ubuntu

├── bin

├── boot

├── dev

├── environment -&gt; .singularity.d/env/90-environment.sh

├── etc

├── home

├── lib

├── lib64

├── media

├── mnt

├── opt

├── proc

├── root

├── run

├── sbin

├── singularity -&gt; .singularity.d/runscript

├── srv

├── sys

├── tmp

├── usr

└── var
</pre></div>
</div>
<p>And you can shell into it just like a normal container.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity shell ubuntu

Singularity: Invoking an interactive shell within container...


Singularity ubuntu:~/Desktop&gt; touch /hello.txt

touch: cannot touch &#39;/hello.txt&#39;: Permission denied
</pre></div>
</div>
<p>You can make changes to the container (assuming you have the proper
permissions to do so) but those changes will disappear as soon as you
exit. To make your changes persistent across sessions, use the <code class="docutils literal notranslate"><span class="pre">--writable</span></code> option.
It’s also a good practice to shell into your container as root to
ensure you have permissions to write where you like.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity shell ubuntu

Singularity: Invoking an interactive shell within container...


Singularity ubuntu:/home/vanessa/Desktop&gt; touch /hello.txt
</pre></div>
</div>
</div>
<div class="section" id="writable-image">
<h4>Writable Image<a class="headerlink" href="#writable-image" title="Permalink to this headline">¶</a></h4>
<p>If you prefer to work with a writable image file rather than a
directory, you can perform a similar development build and specify the <code class="docutils literal notranslate"><span class="pre">--writable</span></code>
option. This will produce an image that is writable with an ext3 file
system. Unlike the sandbox, it is a single image file.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity build --writable ubuntu.img docker://ubuntu

Docker image path: index.docker.io/library/ubuntu:latest

Cache folder set to /root/.singularity/docker

Importing: base Singularity environment

Importing: /root/.singularity/docker/sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118.tar.gz

Importing: /root/.singularity/docker/sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a.tar.gz

Importing: /root/.singularity/docker/sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2.tar.gz

Importing: /root/.singularity/docker/sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e.tar.gz

Importing: /root/.singularity/docker/sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9.tar.gz

Importing: /root/.singularity/metadata/sha256:22e289880847a9a2f32c62c237d2f7e3f4eae7259bf1d5c7ec7ffa19c1a483c8.tar.gz

Building image from sandbox: /tmp/.singularity-build.VCHPpP

Creating empty Singularity writable container 130MB

Creating empty 162MiB image file: ubuntu.img

Formatting image with ext3 file system

Image is done: ubuntu.img

Building Singularity image...


Cleaning up...


Singularity container built: ubuntu.img
</pre></div>
</div>
<p>You can use this image with commands like <code class="docutils literal notranslate"><span class="pre">shell</span></code>, <code class="docutils literal notranslate"><span class="pre">exec</span></code> , <code class="docutils literal notranslate"><span class="pre">run</span></code> , and if you want to
change the image you must use the <code class="docutils literal notranslate"><span class="pre">--writable</span></code> flag. As before, it’s a good idea to
issue these commands as root to ensure you have the proper permissions
to write.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity shell --writable ubuntu.img


Development Tip! When building containers, it often is the case that

you will have a lot of testing of installation commands, and if

building a production image, one error will stop the entire build.

If you interactively write the build recipe with one of these

writable containers, you can debug as you go, and then build the

production (squashfs) container without worrying that it will error

and need to be started again.
</pre></div>
</div>
</div>
</div>
<div class="section" id="production-commands">
<h3>2. Production Commands<a class="headerlink" href="#production-commands" title="Permalink to this headline">¶</a></h3>
<p>Let’s set the scene - we just finished building our perfect hello world
container. It does a fantastic hello-world analysis, and we have written
a paper on it! We now want to build an immutable container - meaning
that if someone obtained our container and tried to change it, they
could not. They could easily use the same recipe that you used (it is
provided as metadata inside the container), or convert your container to
one of the writable formats above using <code class="docutils literal notranslate"><span class="pre">build</span></code> . So your work can still be
extended.</p>
<div class="section" id="recommended-production-build">
<h4>Recommended Production Build<a class="headerlink" href="#recommended-production-build" title="Permalink to this headline">¶</a></h4>
<p>What we want for production is a build into a <a class="reference external" href="https://en.wikipedia.org/wiki/SquashFS">squashfs image</a> .
Squashfs is a read only, and compressed filesystem, and well suited for
confident archive and re-use of your hello-world. To build a production
image, just remove the extra options:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sudo singularity build ubuntu.simg docker://ubuntu

Docker image path: index.docker.io/library/ubuntu:latest

Cache folder set to /root/.singularity/docker

Importing: base Singularity environment

Importing: /root/.singularity/docker/sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118.tar.gz

Importing: /root/.singularity/docker/sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a.tar.gz

Importing: /root/.singularity/docker/sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2.tar.gz

Importing: /root/.singularity/docker/sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e.tar.gz

Importing: /root/.singularity/docker/sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9.tar.gz

Importing: /root/.singularity/metadata/sha256:22e289880847a9a2f32c62c237d2f7e3f4eae7259bf1d5c7ec7ffa19c1a483c8.tar.gz

Building Singularity image...

Cleaning up...

Singularity container built: ubuntu.simg
</pre></div>
</div>
</div>
<div class="section" id="production-build-from-sandbox">
<h4>Production Build from Sandbox<a class="headerlink" href="#production-build-from-sandbox" title="Permalink to this headline">¶</a></h4>
<p>We understand that it might be wanted to build a Singularity (squashfs)
from a previous development image. While we advocate for the first
approach, we support this use case. To do this, given our folder called
“ubuntu/” we made above:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sudo singularity build ubuntu.simg ubuntu/
</pre></div>
</div>
<p>It could be the case that a cluster maintains a “working” base of
container folders (with writable) and then builds and provides
production containers to its users.</p>
<p>If you want to go through this entire process without having
singularity installed locally, or without leaving your cluster, you
can build images using <a class="reference external" href="https://github.com/singularityhub/singularityhub.github.io/wiki">Singularity Hub</a>.</p>
</div>
</div>
</div>
</div>


           </div>

          </div>
          <footer>

    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">

        <a href="bind_paths_and_mounts.html" class="btn btn-neutral float-right" title="Bind Paths and Mounts" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>


        <a href="container_recipes.html" class="btn btn-neutral" title="Container Recipes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>

    </div>


  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Singularity.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>


  <script type="text/javascript" src="_static/js/footer.js"></script>


    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2.6.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>



  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

</body>
</html>
